name: GitHub Copilot Agent Integration

on:
  workflow_run:
    workflows: ["Deploy Forestech to Firebase"]
    types:
      - completed
  workflow_call:
    inputs:
      error_context_file:
        description: 'Path to error context JSON file'
        required: false
        type: string
        default: 'error-context.json'
  workflow_dispatch:
    inputs:
      error_context:
        description: 'Error context for Copilot Agent'
        required: false
        default: ''

jobs:
  copilot-analysis:
    name: Copilot Agent Analysis
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch' }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ü§ñ Copilot Agent - Analyze Build Errors
      uses: github/copilot-agent@v1
      with:
        prompt: |
          ## GitHub Copilot Agent - Forestech Build Error Analysis

          ### Context
          The Forestech project build failed with lint errors. Please analyze the following:

          ### Project Structure
          - **Monorepo**: alimentacion/ and combustibles/ apps
          - **Framework**: React + Vite
          - **Deploy**: Firebase Hosting
          - **Lint**: ESLint with React hooks rules

          ### Recent Errors Pattern
          Based on recent builds, common issues include:
          1. Variables no utilizadas que no siguen patr√≥n /^[A-Z_]/u
          2. Componentes an√≥nimos que afectan Fast Refresh
          3. Archivos mixtos (componentes + constantes)
          4. React Hooks con dependencias incorrectas
          5. Variables 'process' no definidas (should be import.meta.env)

          ### Request
          Please provide:
          1. **Root Cause Analysis**: What specific patterns are causing recurring failures?
          2. **Automated Fix Strategy**: How can we improve our auto-fix scripts?
          3. **Code Improvements**: Specific code changes for problematic files
          4. **Prevention Strategy**: Long-term approach to avoid these issues

          ### Error Context
          ${{ github.event.inputs.error_context || 'No specific error context provided' }}

          Generate a comprehensive analysis and actionable recommendations.
        
        context: |
          Project: Forestech Colombia - Combustibles & Alimentacion Management
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref }}
          Commit: ${{ github.sha }}
          
          Auto-fix scripts available:
          - scripts/fix-all-issues.js (master)
          - scripts/fix-unused-vars.js
          - scripts/fix-anonymous-components.js
          - scripts/fix-environment-vars.js
          - scripts/fix-react-hooks.js

    - name: üìä Generate Copilot Report
      id: copilot-report
      run: |
        echo "COPILOT_ANALYSIS<<EOF" >> $GITHUB_OUTPUT
        echo "## ü§ñ GitHub Copilot Agent Analysis Report" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "**Timestamp:** $(date)" >> $GITHUB_OUTPUT
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_OUTPUT
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### üîç Analysis Results" >> $GITHUB_OUTPUT
        echo "Copilot Agent has been invoked to analyze the build failures." >> $GITHUB_OUTPUT
        echo "The analysis will help improve our auto-fix scripts and prevent future issues." >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### üìã Recommended Actions" >> $GITHUB_OUTPUT
        echo "1. Review Copilot Agent output for specific fixes" >> $GITHUB_OUTPUT
        echo "2. Update auto-fix scripts based on recommendations" >> $GITHUB_OUTPUT
        echo "3. Apply suggested code improvements" >> $GITHUB_OUTPUT
        echo "4. Test improved workflow on next push" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: üîß Create Improvement Issue
      uses: actions/github-script@v7
      with:
        script: |
          const analysis = `${{ steps.copilot-report.outputs.COPILOT_ANALYSIS }}`;
          
          const issueBody = `## ü§ñ Copilot Agent Analysis Report
          
          This issue was automatically created by the GitHub Copilot Agent integration
          to track improvements for the Forestech build system.
          
          ${analysis}
          
          ### üéØ Integration Benefits
          - **Automated Analysis**: Copilot Agent analyzes build failures automatically
          - **Intelligent Recommendations**: AI-powered suggestions for code improvements
          - **Continuous Learning**: System learns from recurring patterns
          - **Zero Manual Intervention**: Fully automated workflow integration
          
          ### üîÑ Next Steps
          1. Review Copilot Agent specific recommendations
          2. Update auto-fix scripts based on analysis
          3. Test improved workflow
          4. Close this issue when improvements are implemented
          
          ---
          **Auto-generated by:** GitHub Copilot Agent Integration
          **Workflow:** copilot-integration.yml
          **Commit:** ${{ github.sha }}`;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ü§ñ Copilot Agent Analysis - Build Improvement Recommendations`,
            body: issueBody,
            labels: ['copilot-agent', 'build-improvement', 'automation']
          });

    - name: üöÄ Success Summary
      run: |
        echo "‚úÖ GitHub Copilot Agent integration completed successfully!"
        echo ""
        echo "üîç Analysis Status: Completed"
        echo "üìä Report Generated: Yes"
        echo "üéØ Issue Created: Yes"
        echo ""
        echo "The Copilot Agent has analyzed the build failures and provided"
        echo "intelligent recommendations for improving the auto-fix system."
        echo ""
        echo "Check the created issue for detailed recommendations and next steps."