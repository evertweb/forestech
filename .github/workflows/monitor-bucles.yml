name: ğŸ›¡ï¸ Monitor de Bucles Infinitos

on:
  schedule:
    # Ejecutar cada 30 minutos durante horas activas
    - cron: '*/30 8-20 * * 1-5'  # Cada 30 min, 8AM-8PM, Lun-Vie
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Tipo de verificaciÃ³n'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - workflows
          - issues
          - commits

permissions:
  contents: read
  issues: read
  actions: read

jobs:
  monitor-loops:
    name: Detectar Bucles Infinitos
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ” Execute Loop Detection
      id: loop-detection
      run: |
        echo "ğŸ›¡ï¸ Iniciando detecciÃ³n de bucles infinitos..."
        
        CHECK_TYPE="${{ github.event.inputs.check_type || 'full' }}"
        echo "Tipo de verificaciÃ³n: $CHECK_TYPE"
        
        if [ "$CHECK_TYPE" = "full" ]; then
          ./scripts/monitor-bucles.sh monitor
        else
          ./scripts/monitor-bucles.sh "$CHECK_TYPE"
        fi
      continue-on-error: true

    - name: ğŸš¨ Create Alert Issue if Loop Detected
      if: steps.loop-detection.outcome == 'failure'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // Verificar si ya existe un issue de alerta activo
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'bucle-infinito,alerta-sistema',
            state: 'open'
          });
          
          if (existingIssues.data.length > 0) {
            console.log('ğŸ”„ Issue de alerta ya existe, actualizando...');
            
            const existingIssue = existingIssues.data[0];
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `## ğŸš¨ Nueva DetecciÃ³n de Bucle Infinito
              
              **Timestamp:** ${new Date().toISOString()}
              **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              El sistema de monitoreo continÃºa detectando patrones de bucle infinito.
              
              âš ï¸ **AcciÃ³n inmediata requerida para prevenir costos excesivos**`
            });
            
            return;
          }
          
          // Crear nuevo issue de alerta
          const alertIssue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš¨ ALERTA CRÃTICA: Bucle Infinito Detectado en Workflows',
            body: `## ğŸš¨ Sistema de Alerta - Bucle Infinito Detectado
            
            **Timestamp:** ${new Date().toISOString()}
            **Detectado por:** Monitor automatizado de bucles
            **Severidad:** CRÃTICA
            
            ### ğŸ” Detalles de la DetecciÃ³n
            El sistema de monitoreo ha identificado patrones que sugieren un bucle infinito en los workflows:
            
            - âš ï¸ MÃºltiples ejecuciones de workflows en corto tiempo
            - ğŸ¤– Exceso de issues asignados al Copilot Agent
            - ğŸ”„ Patrones de commits automÃ¡ticos consecutivos
            
            ### ğŸ› ï¸ Acciones Inmediatas Requeridas
            
            1. **Revisar workflows recientes** en [Actions](/${context.repo.owner}/${context.repo.repo}/actions)
            2. **Verificar issues del Copilot Agent** abiertos recientemente
            3. **Pausar workflows automÃ¡ticos** temporalmente si es necesario
            4. **Investigar la causa raÃ­z** del comportamiento recursivo
            
            ### ğŸ›¡ï¸ Safeguards Activados
            - Circuit breakers en deploy workflows
            - Rate limiting en creaciÃ³n de issues
            - ValidaciÃ³n de duplicados activa
            
            ### ğŸ“Š InformaciÃ³n TÃ©cnica
            - **Repositorio:** ${context.repo.owner}/${context.repo.repo}
            - **Branch:** ${context.ref}
            - **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ---
            
            ğŸš¨ **Esta es una alerta automatizada del sistema de prevenciÃ³n de bucles infinitos**
            
            Para resolver este issue:
            1. Identifica y corrige la causa del bucle
            2. Verifica que los safeguards funcionen correctamente  
            3. Cierra este issue cuando el sistema estÃ© estable`,
            labels: ['bucle-infinito', 'alerta-sistema', 'urgente', 'automatizacion']
          });
          
          console.log(`ğŸš¨ Issue de alerta creado: #${alertIssue.data.number}`);

    - name: âœ… Monitoring Success
      if: steps.loop-detection.outcome == 'success'
      run: |
        echo "âœ… Monitoreo completado exitosamente"
        echo "No se detectaron bucles infinitos"
        echo "Sistema operando normalmente"

    - name: ğŸ“Š Generate Monitoring Report
      if: always()
      run: |
        echo "ğŸ“Š REPORTE DE MONITOREO - $(date)"
        echo "================================="
        echo "Outcome: ${{ steps.loop-detection.outcome }}"
        echo "Checks ejecutados: ${{ github.event.inputs.check_type || 'full' }}"
        echo "Workflow ID: ${{ github.run_id }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        if [ "${{ steps.loop-detection.outcome }}" = "failure" ]; then
          echo "ğŸš¨ ESTADO: Bucle infinito detectado"
          echo "ğŸ› ï¸ ACCIÃ“N: Issue de alerta creado"
        else
          echo "âœ… ESTADO: Sistema normal"
          echo "ğŸ”„ PRÃ“XIMO CHECK: 30 minutos"
        fi
