import{i as $,k as w,b as T,L as se,a5 as ae,X as te,s as ce,W as ne,u as q,r as l,j as e,ac as k,ad as re,ae as ie,af as oe}from"./index-BQoCA6St.js";const x={VEHICLES:"combustibles_vehicles",MOVEMENTS:"combustibles_movements",PRODUCTS:"combustibles_products",INVENTORY:"combustibles_inventory",SUPPLIERS:"combustibles_suppliers",MAINTENANCE:"combustibles_maintenance",VEHICLE_CATEGORIES:"combustibles_vehicle_categories",PRODUCT_CATEGORIES:"productCategories",MIGRATION_ALIASES:"combustibles_migration_aliases",MIGRATION_LOGS:"migration_logs"},le=[x.MOVEMENTS,x.MAINTENANCE,x.INVENTORY,x.VEHICLES,x.PRODUCTS,x.SUPPLIERS,x.VEHICLE_CATEGORIES,x.PRODUCT_CATEGORIES,x.MIGRATION_ALIASES,x.MIGRATION_LOGS],de=async()=>{try{const a={};for(const[s,t]of Object.entries(x))try{const r=await $(w(T,t));a[s]={name:t,displayName:D(s),count:r.size,icon:U(s)}}catch(r){console.error(`Error getting stats for ${t}:`,r),a[s]={name:t,displayName:D(s),count:0,icon:U(s),error:r.message}}return a}catch(a){throw console.error("Error getting data statistics:",a),new Error("Error al obtener estadísticas de datos: "+a.message)}},F=async(a,s=null)=>{try{console.log(`🗑️ Eliminando colección: ${a}`);let t=0,r=!0;for(;r;){const i=await $(se(w(T,a),ae(100)));if(i.empty){r=!1;break}const m=te(T);i.docs.forEach(N=>{m.delete(N.ref)}),await m.commit(),t+=i.size,s&&s(a,t),console.log(`✅ Eliminados ${t} documentos de ${a}`),i.size<100&&(r=!1)}return{success:!0,deletedCount:t,collection:a}}catch(t){throw console.error(`Error deleting collection ${a}:`,t),new Error(`Error al eliminar colección ${a}: ${t.message}`)}},me=async(a,s=null)=>{try{const t=[];for(const r of a)try{const i=await F(r,s);t.push(i)}catch(i){t.push({success:!1,error:i.message,collection:r})}return t}catch(t){throw console.error("Error deleting specific collections:",t),new Error("Error al eliminar colecciones específicas: "+t.message)}},ue=async(a=null)=>{try{console.log("🔥 Iniciando reset completo de datos...");const s=[];for(const t of le)try{a&&a(`Eliminando ${D(H(t))}...`);const r=await F(t,(i,m)=>{a&&a(`${D(H(i))}: ${m} elementos eliminados`)});s.push(r)}catch(r){console.error(`Error resetting ${t}:`,r),s.push({success:!1,error:r.message,collection:t})}return await xe(s),a&&a("✅ Reset completo terminado"),console.log("✅ Reset completo terminado"),s}catch(s){throw console.error("Error during complete reset:",s),new Error("Error durante el reset completo: "+s.message)}},he=async(a=null)=>{try{console.log("💾 Creando backup de datos...");const s={timestamp:new Date().toISOString(),collections:{}},t=a||Object.values(x);for(const i of t)try{const m=await $(w(T,i));s.collections[i]=m.docs.map(N=>({id:N.id,data:N.data()})),console.log(`📦 Backup creado para ${i}: ${m.size} documentos`)}catch(m){console.error(`Error creating backup for ${i}:`,m),s.collections[i]={error:m.message,count:0}}const r=`combustibles_backup_${Date.now()}`;return localStorage.setItem(r,JSON.stringify(s)),console.log("✅ Backup creado exitosamente"),{success:!0,backupKey:r,backup:s}}catch(s){throw console.error("Error creating backup:",s),new Error("Error al crear backup: "+s.message)}},xe=async a=>{try{const s={action:"COMPLETE_DATA_RESET",timestamp:ce(),results:a,totalCollections:a.length,successfulResets:a.filter(t=>t.success).length,failedResets:a.filter(t=>!t.success).length,totalDocumentsDeleted:a.reduce((t,r)=>t+(r.deletedCount||0),0)};await ne(w(T,"system_logs"),s),console.log("📝 Reset action logged")}catch(s){console.error("Error logging reset action:",s)}},D=a=>({VEHICLES:"Vehículos",MOVEMENTS:"Movimientos",PRODUCTS:"Productos",INVENTORY:"Inventario",SUPPLIERS:"Proveedores",MAINTENANCE:"Mantenimiento",VEHICLE_CATEGORIES:"Categorías de Vehículos",PRODUCT_CATEGORIES:"Categorías de Productos",MIGRATION_ALIASES:"Alias de Migración",MIGRATION_LOGS:"Logs de Migración"})[a]||a,U=a=>({VEHICLES:"🚜",MOVEMENTS:"📈",PRODUCTS:"🛢️",INVENTORY:"📦",SUPPLIERS:"🏪",MAINTENANCE:"🔧",VEHICLE_CATEGORIES:"🏷️",PRODUCT_CATEGORIES:"🏷️",MIGRATION_ALIASES:"🔄",MIGRATION_LOGS:"📋"})[a]||"📄",H=a=>{for(const[s,t]of Object.entries(x))if(t===a)return s;return a},pe=a=>a?.role==="admin",je=()=>{const a=[];for(let s=0;s<localStorage.length;s++){const t=localStorage.key(s);if(t&&t.startsWith("combustibles_backup_"))try{const r=JSON.parse(localStorage.getItem(t));a.push({key:t,timestamp:r.timestamp,collections:Object.keys(r.collections||{}).length})}catch(r){console.error(`Error parsing backup ${t}:`,r)}}return a.sort((s,t)=>new Date(t.timestamp)-new Date(s.timestamp))},ge=()=>{const{userProfile:a}=q(),[s,t]=l.useState({}),[r,i]=l.useState(!0),[m,N]=l.useState(!1),[S,g]=l.useState(""),[u,C]=l.useState([]),[O,p]=l.useState(!1),[h,E]=l.useState(0),[I,y]=l.useState(""),[b,R]=l.useState(""),[v,n]=l.useState(!0),[d,z]=l.useState([]),[P,Y]=l.useState(!1),L=pe(a);l.useEffect(()=>{L&&(G(),M())},[L]);const G=async()=>{try{i(!0);const c=await de();t(c)}catch(c){console.error("Error loading stats:",c)}finally{i(!1)}},M=()=>{const c=je();z(c)},J=c=>{C(o=>o.includes(c)?o.filter(_=>_!==c):[...o,c])},W=()=>{const c=Object.keys(s).filter(o=>s[o].count>0);C(o=>o.length===c.length?[]:c)},V=c=>{if(c==="selected"&&u.length===0){alert("Selecciona al menos una colección para eliminar");return}R(c),p(!0),E(0),y("")},K=()=>{if(h===0)E(1);else if(h===1){const c=b==="complete"?"RESET COMPLETO":"ELIMINAR SELECCIONADOS";I===c?E(2):alert(`Debes escribir exactamente: ${c}`)}else h===2&&X()},X=async()=>{try{if(N(!0),p(!1),g("Iniciando proceso de eliminación..."),v){g("Creando backup de seguridad...");const j=b==="complete"?null:u.map(f=>s[f].name);await he(j),g("Backup creado exitosamente")}let c;if(b==="complete")c=await ue(j=>{g(j)});else{const j=u.map(f=>s[f].name);c=await me(j,(f,ee)=>{g(`${f}: ${ee} elementos eliminados`)})}const o=c.filter(j=>j.success).length,_=c.filter(j=>!j.success).length,Z=c.reduce((j,f)=>j+(f.deletedCount||0),0);g(`✅ Proceso completado: ${o} exitosos, ${_} fallidos. Total eliminados: ${Z}`),setTimeout(()=>{G(),M(),C([]),g("")},3e3)}catch(c){console.error("Error during reset:",c),g(`❌ Error: ${c.message}`)}finally{N(!1)}},Q=()=>{p(!1),E(0),y(""),R("")},A=()=>Object.values(s).reduce((c,o)=>c+(o.count||0),0),B=()=>u.reduce((c,o)=>c+(s[o]?.count||0),0);return L?r?e.jsx("div",{className:"data-reset",children:e.jsxs("div",{className:"loading",children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:"Cargando estadísticas de datos..."})]})}):e.jsxs("div",{className:"data-reset",children:[e.jsxs("div",{className:"reset-header",children:[e.jsx("h2",{children:"🔥 Reset de Datos"}),e.jsxs("p",{children:["Administra y elimina datos de la aplicación. ",e.jsx("strong",{children:"¡Usa con precaución!"})]})]}),(m||S)&&e.jsx("div",{className:"progress-section",children:e.jsxs("div",{className:"progress-bar",children:[m&&e.jsx("div",{className:"progress-spinner"}),e.jsx("span",{children:S})]})}),e.jsxs("div",{className:"stats-summary",children:[e.jsxs("div",{className:"summary-card",children:[e.jsx("h3",{children:"📊 Resumen de Datos"}),e.jsxs("div",{className:"summary-stats",children:[e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-number",children:Object.keys(s).length}),e.jsx("span",{className:"stat-label",children:"Colecciones"})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-number",children:A()}),e.jsx("span",{className:"stat-label",children:"Documentos Totales"})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-number",children:u.length}),e.jsx("span",{className:"stat-label",children:"Seleccionadas"})]})]})]}),e.jsxs("div",{className:"summary-card",children:[e.jsx("h3",{children:"💾 Opciones de Backup"}),e.jsxs("div",{className:"backup-options",children:[e.jsxs("label",{className:"backup-toggle",children:[e.jsx("input",{type:"checkbox",checked:v,onChange:c=>n(c.target.checked)}),e.jsx("span",{children:"Crear backup antes del reset"})]}),e.jsxs("button",{className:"btn-secondary",onClick:()=>Y(!P),children:["📋 Ver Backups (",d.length,")"]})]})]})]}),P&&e.jsxs("div",{className:"backups-section",children:[e.jsx("h3",{children:"💾 Backups Disponibles"}),d.length===0?e.jsx("p",{children:"No hay backups disponibles"}):e.jsx("div",{className:"backups-list",children:d.map(c=>e.jsxs("div",{className:"backup-item",children:[e.jsxs("div",{className:"backup-info",children:[e.jsx("span",{className:"backup-date",children:new Date(c.timestamp).toLocaleString()}),e.jsxs("span",{className:"backup-collections",children:[c.collections," colecciones"]})]}),e.jsx("button",{className:"btn-danger btn-small",onClick:()=>{window.confirm("¿Eliminar este backup?")&&(localStorage.removeItem(c.key),M())},children:"🗑️"})]},c.key))})]}),e.jsxs("div",{className:"collections-section",children:[e.jsxs("div",{className:"collections-header",children:[e.jsx("h3",{children:"📋 Colecciones de Datos"}),e.jsx("div",{className:"collection-actions",children:e.jsx("button",{className:"btn-secondary",onClick:W,disabled:m,children:u.length===Object.keys(s).filter(c=>s[c].count>0).length?"Deseleccionar Todo":"Seleccionar Todo"})})]}),e.jsx("div",{className:"collections-grid",children:Object.entries(s).map(([c,o])=>e.jsxs("div",{className:`collection-card ${u.includes(c)?"selected":""}`,children:[e.jsxs("div",{className:"collection-header",children:[e.jsx("div",{className:"collection-icon",children:o.icon}),e.jsxs("div",{className:"collection-info",children:[e.jsx("h4",{children:o.displayName}),e.jsx("p",{className:"collection-name",children:o.name})]}),e.jsx("label",{className:"collection-checkbox",children:e.jsx("input",{type:"checkbox",checked:u.includes(c),onChange:()=>J(c),disabled:m||o.count===0})})]}),e.jsxs("div",{className:"collection-stats",children:[e.jsxs("div",{className:"stat-item",children:[e.jsx("span",{className:"stat-number",children:o.count}),e.jsx("span",{className:"stat-label",children:"Documentos"})]}),o.error&&e.jsxs("div",{className:"stat-error",children:["⚠️ ",o.error]})]})]},c))})]}),e.jsxs("div",{className:"reset-actions",children:[e.jsxs("button",{className:"btn-warning",onClick:()=>V("selected"),disabled:m||u.length===0,children:["🗑️ Eliminar Seleccionadas (",B()," docs)"]}),e.jsxs("button",{className:"btn-danger",onClick:()=>V("complete"),disabled:m||A()===0,children:["🔥 Reset Completo (",A()," docs)"]})]}),O&&e.jsx("div",{className:"confirmation-modal",children:e.jsxs("div",{className:"modal-content",children:[e.jsx("div",{className:"modal-header",children:e.jsxs("h3",{children:[h===0&&"⚠️ Confirmación Requerida",h===1&&"✍️ Confirmación por Texto",h===2&&"🔥 Confirmación Final"]})}),e.jsxs("div",{className:"modal-body",children:[h===0&&e.jsxs("div",{className:"confirmation-step",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"ADVERTENCIA:"})," Esta acción ",b==="complete"?"eliminará TODOS los datos":"eliminará las colecciones seleccionadas"," de la aplicación."]}),e.jsxs("ul",{children:[b==="complete"?e.jsxs("li",{children:["Se eliminarán ",A()," documentos de todas las colecciones"]}):e.jsxs(e.Fragment,{children:[e.jsxs("li",{children:["Se eliminarán ",B()," documentos"]}),e.jsxs("li",{children:["Colecciones afectadas: ",u.map(c=>s[c].displayName).join(", ")]})]}),e.jsx("li",{children:"Esta acción NO se puede deshacer"}),v&&e.jsx("li",{children:"Se creará un backup antes de proceder"})]})]}),h===1&&e.jsxs("div",{className:"confirmation-step",children:[e.jsx("p",{children:"Para continuar, escribe exactamente el siguiente texto:"}),e.jsx("div",{className:"confirmation-text-required",children:b==="complete"?"RESET COMPLETO":"ELIMINAR SELECCIONADOS"}),e.jsx("input",{type:"text",value:I,onChange:c=>y(c.target.value),placeholder:"Escribe el texto aquí",className:"confirmation-input"})]}),h===2&&e.jsxs("div",{className:"confirmation-step",children:[e.jsxs("p",{className:"final-warning",children:[e.jsx("strong",{children:"ÚLTIMA CONFIRMACIÓN:"})," ¿Estás completamente seguro de que quieres proceder?"]}),e.jsx("p",{children:"Esta es tu última oportunidad para cancelar."})]})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn-secondary",onClick:Q,children:"Cancelar"}),e.jsx("button",{className:"btn-danger",onClick:K,disabled:h===1&&!I,children:h===2?"Proceder con Eliminación":"Continuar"})]})]})})]}):e.jsx("div",{className:"data-reset",children:e.jsxs("div",{className:"permission-denied",children:[e.jsx("h2",{children:"🚫 Acceso Denegado"}),e.jsx("p",{children:"Solo los administradores pueden acceder a la función de reset de datos."})]})})},Ee=()=>{const{user:a,userProfile:s}=q(),[t,r]=l.useState("invitations"),[i,m]=l.useState([]),[N,S]=l.useState(!1),[g,u]=l.useState(!1),[C,O]=l.useState(!1),[p,h]=l.useState({email:"",name:"",role:k.CLIENTE});l.useEffect(()=>{a&&s?.role==="admin"&&E()},[a,s]);const E=l.useCallback(async()=>{if(a){S(!0);try{const n=await re(a.uid);n.success?m(n.invitations):console.error("Error loading invitations:",n.error)}catch(n){console.error("Error loading invitations:",n)}finally{S(!1)}}},[a]),I=async n=>{n.preventDefault(),O(!0);try{const d=await oe(p,a.uid);d.success?(h({email:"",name:"",role:k.CLIENTE}),u(!1),await E(),alert(`Invitación creada exitosamente!
Código: ${d.invitation.code}`)):alert(`Error: ${d.error}`)}catch(d){console.error("Error creating invitation:",d),alert("Error creando invitación")}finally{O(!1)}},y=async n=>{if(confirm("¿Estás seguro de cancelar esta invitación?"))try{const d=await ie(n,a.uid);d.success?(await E(),alert("Invitación cancelada exitosamente")):alert(`Error: ${d.error}`)}catch(d){console.error("Error cancelling invitation:",d),alert("Error cancelando invitación")}},b=n=>({pending:{text:"Pendiente",class:"status-pending"},used:{text:"Usada",class:"status-used"},cancelled:{text:"Cancelada",class:"status-cancelled"},expired:{text:"Expirada",class:"status-expired"}})[n]||{text:n,class:"status-unknown"},R=n=>({admin:"Administrador",contador:"Contador",cliente:"Cliente"})[n]||n,v=n=>n?(n.toDate?n.toDate():new Date(n)).toLocaleDateString("es-ES",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A";return s?.role!=="admin"?e.jsxs("div",{className:"admin-unauthorized",children:[e.jsx("h2",{children:"⛔ Acceso Denegado"}),e.jsx("p",{children:"Solo los administradores pueden acceder a esta sección."})]}):e.jsxs("div",{className:"admin-main",children:[e.jsxs("div",{className:"admin-header",children:[e.jsx("h1",{children:"⚙️ Administración del Sistema"}),e.jsx("p",{children:"Gestión de usuarios y configuraciones"})]}),e.jsxs("div",{className:"admin-tabs",children:[e.jsx("button",{className:`tab-button ${t==="invitations"?"active":""}`,onClick:()=>r("invitations"),children:"🎫 Invitaciones"}),e.jsx("button",{className:`tab-button ${t==="users"?"active":""}`,onClick:()=>r("users"),children:"👥 Usuarios"}),e.jsx("button",{className:`tab-button ${t==="settings"?"active":""}`,onClick:()=>r("settings"),children:"⚙️ Configuración"}),e.jsx("button",{className:`tab-button ${t==="reset"?"active":""}`,onClick:()=>r("reset"),children:"🔥 Reset de Datos"})]}),e.jsxs("div",{className:"admin-content",children:[t==="invitations"&&e.jsxs("div",{className:"invitations-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"Gestión de Invitaciones"}),e.jsx("button",{className:"create-button",onClick:()=>u(!0),children:"+ Crear Invitación"})]}),N?e.jsx("div",{className:"loading",children:"Cargando invitaciones..."}):e.jsxs("div",{className:"invitations-table",children:[e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Código"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"Rol"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Creada"}),e.jsx("th",{children:"Expira"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:i.map(n=>{const d=b(n.status);return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("code",{className:"invitation-code",children:n.code})}),e.jsx("td",{children:n.targetEmail}),e.jsx("td",{children:n.targetName||"-"}),e.jsx("td",{children:R(n.targetRole)}),e.jsx("td",{children:e.jsx("span",{className:`status-badge ${d.class}`,children:d.text})}),e.jsx("td",{children:v(n.createdAt)}),e.jsx("td",{children:v(n.expiresAt)}),e.jsx("td",{children:n.status==="pending"&&e.jsx("button",{className:"cancel-button",onClick:()=>y(n.id),children:"Cancelar"})})]},n.id)})})]}),i.length===0&&e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:"No hay invitaciones creadas"})})]})]}),t==="users"&&e.jsxs("div",{className:"users-section",children:[e.jsx("h2",{children:"👥 Usuarios del Sistema"}),e.jsxs("div",{className:"coming-soon",children:[e.jsx("span",{children:"🚧 En desarrollo"}),e.jsx("p",{children:"Próximamente: Lista de usuarios registrados, edición de permisos, y estadísticas."})]})]}),t==="settings"&&e.jsxs("div",{className:"settings-section",children:[e.jsx("h2",{children:"⚙️ Configuración del Sistema"}),e.jsxs("div",{className:"coming-soon",children:[e.jsx("span",{children:"🚧 En desarrollo"}),e.jsx("p",{children:"Próximamente: Configuraciones generales, notificaciones, y parámetros del sistema."})]})]}),t==="reset"&&e.jsx(ge,{})]}),g&&e.jsx("div",{className:"modal-overlay",onClick:()=>u(!1),children:e.jsxs("div",{className:"modal-content",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Crear Nueva Invitación"}),e.jsx("button",{className:"modal-close",onClick:()=>u(!1),children:"×"})]}),e.jsxs("form",{onSubmit:I,className:"invitation-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"email",children:"Email del usuario:"}),e.jsx("input",{id:"email",type:"email",required:!0,value:p.email,onChange:n=>h({...p,email:n.target.value}),placeholder:"usuario@ejemplo.com"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"name",children:"Nombre (opcional):"}),e.jsx("input",{id:"name",type:"text",value:p.name,onChange:n=>h({...p,name:n.target.value}),placeholder:"Nombre del usuario"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"role",children:"Rol:"}),e.jsxs("select",{id:"role",value:p.role,onChange:n=>h({...p,role:n.target.value}),children:[e.jsx("option",{value:k.CLIENTE,children:"Cliente"}),e.jsx("option",{value:k.CONTADOR,children:"Contador"}),e.jsx("option",{value:k.ADMIN,children:"Administrador"})]})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"cancel-button",onClick:()=>u(!1),children:"Cancelar"}),e.jsx("button",{type:"submit",className:"create-button",disabled:C,children:C?"Creando...":"Crear Invitación"})]})]})]})})]})};export{Ee as default};
