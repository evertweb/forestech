import{r as m,j as e,D as B,f,a as L}from"./index-M96RpLqe.js";import{a as g,s as V,b as I,c as M,d as D,u as U}from"./productsService-361b-ndK.js";const z=({isOpen:y,onClose:p,product:o,mode:u="create",onSave:k,userRole:T})=>{const[c,b]=m.useState({name:"",displayName:"",category:g.COMBUSTIBLE,unit:"gal",defaultPrice:0,color:"#FF6B35",icon:"🛢️",description:"",isActive:!0,currentStock:0,minThreshold:10,maxCapacity:1e3}),[i,S]=m.useState({}),[C,P]=m.useState(!1),E=[{value:"gal",label:"Galones (gal)"},{value:"L",label:"Litros (L)"},{value:"kg",label:"Kilogramos (kg)"},{value:"und",label:"Unidades (und)"}],j={[g.COMBUSTIBLE]:["🛢️","🚛","🚗","⛽","🌿"],[g.ACEITE]:["🛢️","⚙️","🔧","🚜","🏭"],[g.LUBRICANTE]:["🟥","🟡","🔵","⚫","🟤"],[g.FLUIDO]:["🛑","💧","🔴","🟢","🔵"]},t=["#FF6B35","#4CAF50","#2196F3","#FF9800","#F44336","#9C27B0","#E91E63","#795548","#607D8B","#3F51B5"];m.useEffect(()=>{b(o&&(u==="edit"||u==="view")?{name:o.name||"",displayName:o.displayName||"",category:o.category||g.COMBUSTIBLE,unit:o.unit||"gal",defaultPrice:o.defaultPrice||0,color:o.color||"#FF6B35",icon:o.icon||"🛢️",description:o.description||"",isActive:o.isActive!==void 0?o.isActive:!0,currentStock:o.currentStock||0,minThreshold:o.minThreshold||10,maxCapacity:o.maxCapacity||1e3}:{name:"",displayName:"",category:g.COMBUSTIBLE,unit:"gal",defaultPrice:0,color:"#FF6B35",icon:"🛢️",description:"",isActive:!0,currentStock:0,minThreshold:10,maxCapacity:1e3}),S({})},[o,u,y]);const a=s=>{const{name:h,value:A,type:x,checked:w}=s.target;b(F=>({...F,[h]:x==="checkbox"?w:A})),i[h]&&S(F=>({...F,[h]:""}))},v=()=>{const s={};return c.name.trim()||(s.name="El nombre es requerido"),c.displayName.trim()||(s.displayName="El nombre de visualización es requerido"),c.category||(s.category="La categoría es requerida"),c.unit||(s.unit="La unidad es requerida"),c.defaultPrice<0&&(s.defaultPrice="El precio debe ser mayor o igual a 0"),c.currentStock<0&&(s.currentStock="El stock debe ser mayor o igual a 0"),c.minThreshold<0&&(s.minThreshold="El umbral mínimo debe ser mayor o igual a 0"),c.maxCapacity<=0&&(s.maxCapacity="La capacidad máxima debe ser mayor a 0"),c.minThreshold>=c.maxCapacity&&(s.minThreshold="El umbral mínimo debe ser menor que la capacidad máxima"),S(s),Object.keys(s).length===0},d=async s=>{if(s.preventDefault(),!!v()){P(!0);try{await k({...c,defaultPrice:parseFloat(c.defaultPrice),currentStock:parseFloat(c.currentStock),minThreshold:parseFloat(c.minThreshold),maxCapacity:parseFloat(c.maxCapacity)}),p()}catch(h){console.error("Error saving product:",h),S({submit:"Error al guardar el producto"})}finally{P(!1)}}};if(!y)return null;const l=["admin","supervisor"].includes(T)&&u!=="view";return e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal-content product-modal",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h2",{children:[u==="create"&&"➕ Crear Producto",u==="edit"&&"✏️ Editar Producto",u==="view"&&"👁️ Ver Producto"]}),e.jsx("button",{className:"modal-close",onClick:p,children:"✕"})]}),e.jsxs("form",{onSubmit:d,className:"modal-body",children:[e.jsx("div",{className:"product-preview",children:e.jsxs("div",{className:"preview-card",children:[e.jsx("div",{className:"preview-icon",style:{color:c.color},children:c.icon}),e.jsxs("div",{className:"preview-info",children:[e.jsx("h3",{children:c.displayName||"Nombre del producto"}),e.jsx("p",{className:"preview-category",children:c.category}),e.jsx("p",{className:"preview-description",children:c.description}),e.jsxs("div",{className:"preview-price",children:["$",new Intl.NumberFormat("es-CO").format(c.defaultPrice)," / ",c.unit]})]})]})}),e.jsxs("div",{className:"form-grid",children:[e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{children:"📝 Información Básica"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Nombre Interno *"}),e.jsx("input",{type:"text",name:"name",value:c.name,onChange:a,disabled:!l,placeholder:"Ej: ACPM, GASOLINA"}),i.name&&e.jsx("span",{className:"error",children:i.name})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Nombre de Visualización *"}),e.jsx("input",{type:"text",name:"displayName",value:c.displayName,onChange:a,disabled:!l,placeholder:"Ej: ACPM 🚛, Gasolina 🚗"}),i.displayName&&e.jsx("span",{className:"error",children:i.displayName})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Categoría *"}),e.jsx("select",{name:"category",value:c.category,onChange:a,disabled:!l,children:Object.values(g).map(s=>e.jsx("option",{value:s,children:s},s))}),i.category&&e.jsx("span",{className:"error",children:i.category})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Descripción"}),e.jsx("textarea",{name:"description",value:c.description,onChange:a,disabled:!l,placeholder:"Descripción del producto...",rows:"3"})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{children:"⚙️ Configuración"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Unidad de Medida *"}),e.jsx("select",{name:"unit",value:c.unit,onChange:a,disabled:!l,children:E.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),i.unit&&e.jsx("span",{className:"error",children:i.unit})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Precio por Defecto"}),e.jsx("input",{type:"number",name:"defaultPrice",value:c.defaultPrice,onChange:a,disabled:!l,min:"0",step:"0.01"}),i.defaultPrice&&e.jsx("span",{className:"error",children:i.defaultPrice})]}),e.jsx("div",{className:"form-group",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",name:"isActive",checked:c.isActive,onChange:a,disabled:!l}),"Producto Activo"]})})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{children:"📊 Stock y Umbrales"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Stock Actual"}),e.jsx("input",{type:"number",name:"currentStock",value:c.currentStock,onChange:a,disabled:!l,min:"0",step:"0.01"}),i.currentStock&&e.jsx("span",{className:"error",children:i.currentStock})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Umbral Mínimo"}),e.jsx("input",{type:"number",name:"minThreshold",value:c.minThreshold,onChange:a,disabled:!l,min:"0",step:"0.01"}),i.minThreshold&&e.jsx("span",{className:"error",children:i.minThreshold})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Capacidad Máxima"}),e.jsx("input",{type:"number",name:"maxCapacity",value:c.maxCapacity,onChange:a,disabled:!l,min:"1",step:"0.01"}),i.maxCapacity&&e.jsx("span",{className:"error",children:i.maxCapacity})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{children:"🎨 Apariencia"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Icono"}),e.jsx("div",{className:"icon-selector",children:j[c.category]?.map(s=>e.jsx("button",{type:"button",className:`icon-option ${c.icon===s?"selected":""}`,onClick:()=>b(h=>({...h,icon:s})),disabled:!l,children:s},s))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Color"}),e.jsx("div",{className:"color-selector",children:t.map(s=>e.jsx("button",{type:"button",className:`color-option ${c.color===s?"selected":""}`,style:{backgroundColor:s},onClick:()=>b(h=>({...h,color:s})),disabled:!l},s))})]})]})]}),i.submit&&e.jsx("div",{className:"error-message",children:i.submit})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:p,disabled:C,children:u==="view"?"Cerrar":"Cancelar"}),l&&e.jsx("button",{type:"submit",className:"btn-primary",onClick:d,disabled:C,children:C?"Guardando...":"Guardar"})]})]})})},$=({products:y})=>{const[p,o]=m.useState([]),[u,k]=m.useState(!0);m.useEffect(()=>{const t=B(a=>{o(a),k(!1)},a=>{console.error("Error loading movements for stats:",a),k(!1)});return()=>t()},[]);const T=()=>y.map(a=>{const v=p.filter(x=>x.fuelType===a.name||x.fuelType===a.displayName),d=v.filter(x=>x.type==="entrada"),l=v.filter(x=>x.type==="salida"),s=d.reduce((x,w)=>x+(w.quantity||0),0),h=l.reduce((x,w)=>x+(w.quantity||0),0),A=(a.currentStock||0)*(a.defaultPrice||0);return{...a,totalEntries:s,totalExits:h,totalValue:A,entriesCount:d.length,exitsCount:l.length,stockStatus:c(a)}}),c=t=>{const a=t.currentStock||0,v=t.minThreshold||0,d=t.maxCapacity||1e3;return a===0?"empty":a<=v?"low":a>=d*.9?"high":"normal"},b=t=>{const a={};return Object.values(g).forEach(v=>{const d=t.filter(l=>l.category===v);a[v]={totalProducts:d.length,totalStock:d.reduce((l,s)=>l+(s.currentStock||0),0),totalValue:d.reduce((l,s)=>l+s.totalValue,0),totalEntries:d.reduce((l,s)=>l+s.totalEntries,0),totalExits:d.reduce((l,s)=>l+s.totalExits,0),lowStockCount:d.filter(l=>l.stockStatus==="low"||l.stockStatus==="empty").length}}),a};if(u)return e.jsxs("div",{className:"products-stats loading",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Cargando estadísticas..."})]});const i=T(),S=b(i),C=y.length,P=y.filter(t=>t.isActive).length,E=i.reduce((t,a)=>t+a.totalValue,0),j=i.filter(t=>t.stockStatus==="low"||t.stockStatus==="empty").length;return e.jsxs("div",{className:"products-stats",children:[e.jsx("h2",{children:"📊 Estadísticas de Productos"}),e.jsxs("div",{className:"stats-general",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon",children:"📦"}),e.jsxs("div",{className:"stat-info",children:[e.jsx("h3",{children:f(C)}),e.jsx("p",{children:"Total Productos"})]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon",children:"✅"}),e.jsxs("div",{className:"stat-info",children:[e.jsx("h3",{children:f(P)}),e.jsx("p",{children:"Productos Activos"})]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon",children:"💰"}),e.jsxs("div",{className:"stat-info",children:[e.jsx("h3",{children:L(E)}),e.jsx("p",{children:"Valor Total Stock"})]})]}),e.jsxs("div",{className:`stat-card ${j>0?"alert":""}`,children:[e.jsx("div",{className:"stat-icon",children:"⚠️"}),e.jsxs("div",{className:"stat-info",children:[e.jsx("h3",{children:f(j)}),e.jsx("p",{children:"Stock Bajo"})]})]})]}),e.jsxs("div",{className:"stats-categories",children:[e.jsx("h3",{children:"📈 Por Categoría"}),e.jsx("div",{className:"categories-grid",children:Object.entries(S).map(([t,a])=>e.jsxs("div",{className:"category-card",children:[e.jsx("h4",{children:t}),e.jsxs("div",{className:"category-stats",children:[e.jsxs("div",{className:"stat-row",children:[e.jsx("span",{children:"Productos:"}),e.jsx("span",{children:f(a.totalProducts)})]}),e.jsxs("div",{className:"stat-row",children:[e.jsx("span",{children:"Stock Total:"}),e.jsxs("span",{children:[f(a.totalStock)," unidades"]})]}),e.jsxs("div",{className:"stat-row",children:[e.jsx("span",{children:"Valor:"}),e.jsx("span",{children:L(a.totalValue)})]}),e.jsxs("div",{className:"stat-row",children:[e.jsx("span",{children:"Entradas:"}),e.jsx("span",{className:"positive",children:f(a.totalEntries)})]}),e.jsxs("div",{className:"stat-row",children:[e.jsx("span",{children:"Salidas:"}),e.jsx("span",{className:"negative",children:f(a.totalExits)})]}),a.lowStockCount>0&&e.jsxs("div",{className:"stat-row alert",children:[e.jsx("span",{children:"Stock Bajo:"}),e.jsx("span",{children:f(a.lowStockCount)})]})]})]},t))})]}),e.jsxs("div",{className:"stats-top-products",children:[e.jsx("h3",{children:"🏆 Top Productos por Stock"}),e.jsx("div",{className:"top-products-list",children:i.sort((t,a)=>(a.currentStock||0)-(t.currentStock||0)).slice(0,5).map((t,a)=>e.jsxs("div",{className:"top-product-item",children:[e.jsxs("div",{className:"rank",children:["#",a+1]}),e.jsx("div",{className:"product-icon",style:{color:t.color},children:t.icon}),e.jsxs("div",{className:"product-info",children:[e.jsx("span",{className:"product-name",children:t.displayName}),e.jsxs("span",{className:"product-stock",children:[f(t.currentStock||0)," ",t.unit]})]}),e.jsx("div",{className:"product-value",children:L(t.totalValue)})]},t.id))})]}),j>0&&e.jsxs("div",{className:"stats-alerts",children:[e.jsx("h3",{children:"⚠️ Alertas de Stock"}),e.jsx("div",{className:"alerts-list",children:i.filter(t=>t.stockStatus==="low"||t.stockStatus==="empty").map(t=>e.jsxs("div",{className:`alert-item ${t.stockStatus}`,children:[e.jsx("div",{className:"alert-icon",children:t.stockStatus==="empty"?"🔴":"🟡"}),e.jsxs("div",{className:"alert-info",children:[e.jsx("span",{className:"alert-product",children:t.displayName}),e.jsxs("span",{className:"alert-stock",children:["Stock: ",f(t.currentStock||0)," ",t.unit,t.stockStatus==="empty"&&" - ¡SIN STOCK!",t.stockStatus==="low"&&` - Mínimo: ${t.minThreshold}`]})]})]},t.id))})]})]})},R=({userProfile:y})=>{const[p,o]=m.useState([]),[u,k]=m.useState(!0),[T,c]=m.useState(null),[b,i]=m.useState(!1),[S,C]=m.useState(null),[P,E]=m.useState("create"),[j,t]=m.useState(""),[a,v]=m.useState(""),[d,l]=m.useState(!0),s=["admin","supervisor"].includes(y?.role);m.useEffect(()=>{k(!0);const r=V(n=>{o(n),k(!1),c(null)},n=>{console.error("Error loading products:",n),c("Error cargando productos"),k(!1)});return()=>r()},[]),m.useEffect(()=>{(async()=>{if(console.log("🔍 Debug - Inicializando productos:",{productsLength:p.length,loading:u,canManageProducts:s}),p.length===0&&!u&&s)try{console.log("🚀 Creando productos predefinidos...");const n=I();console.log("📦 Productos predefinidos:",n);for(const N of n)console.log("➕ Creando producto:",N.name),await M({name:N.name,displayName:N.displayName,category:N.category,unit:N.unit,defaultPrice:N.defaultPrice,color:N.color,icon:N.icon,description:N.description,isActive:!0,currentStock:0,minThreshold:10,maxCapacity:1e3});console.log("✅ Productos predefinidos creados exitosamente")}catch(n){console.error("❌ Error inicializando productos:",n)}else console.log("ℹ️ No se inicializan productos:",{reason:p.length>0?"Ya existen productos":u?"Está cargando":s?"Otra razón":"Sin permisos"})})()},[p.length,u,s]);const h=()=>{C(null),E("create"),i(!0)},A=r=>{C(r),E("edit"),i(!0)},x=r=>{C(r),E("view"),i(!0)},w=async r=>{if(window.confirm("¿Estás seguro de que deseas eliminar este producto?"))try{await D(r)}catch(n){console.error("Error deleting product:",n),alert("Error al eliminar el producto")}},F=async r=>{try{P==="create"?await M(r):P==="edit"&&await U(S.id,r),i(!1)}catch(n){throw console.error("Error saving product:",n),n}},O=p.filter(r=>{const n=r.displayName?.toLowerCase().includes(j.toLowerCase())||r.name?.toLowerCase().includes(j.toLowerCase()),N=!a||r.category===a;return n&&N});return u?e.jsx("div",{className:"products-main",children:e.jsxs("div",{className:"loading-container",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Cargando productos..."})]})}):T?e.jsx("div",{className:"products-main",children:e.jsxs("div",{className:"error-container",children:[e.jsxs("p",{children:["⚠️ ",T]}),e.jsx("button",{onClick:()=>window.location.reload(),children:"Reintentar"})]})}):e.jsxs("div",{className:"products-main",children:[e.jsxs("div",{className:"products-header",children:[e.jsxs("div",{className:"header-title",children:[e.jsx("h1",{children:"🛢️ Gestión de Productos"}),e.jsx("p",{children:"Administra los tipos de combustibles y productos disponibles"})]}),s&&e.jsxs("div",{className:"header-actions",children:[e.jsx("button",{className:"btn-primary",onClick:h,children:"➕ Agregar Producto"}),e.jsx("button",{className:"btn-secondary",onClick:async()=>{try{console.log("🧪 Forzando creación de productos predefinidos...");const r=I();for(const n of r)await M({name:n.name,displayName:n.displayName,category:n.category,unit:n.unit,defaultPrice:n.defaultPrice,color:n.color,icon:n.icon,description:n.description,isActive:!0,currentStock:0,minThreshold:10,maxCapacity:1e3});alert("Productos predefinidos creados exitosamente")}catch(r){console.error("Error:",r),alert("Error creando productos: "+r.message)}},style:{marginLeft:"10px"},children:"🧪 Crear Predefinidos"})]})]}),d&&e.jsx($,{products:p}),e.jsxs("div",{className:"products-filters",children:[e.jsx("div",{className:"filter-group",children:e.jsx("input",{type:"text",placeholder:"🔍 Buscar productos...",value:j,onChange:r=>t(r.target.value),className:"search-input"})}),e.jsx("div",{className:"filter-group",children:e.jsxs("select",{value:a,onChange:r=>v(r.target.value),className:"filter-select",children:[e.jsx("option",{value:"",children:"🏷️ Todas las categorías"}),Object.values(g).map(r=>e.jsx("option",{value:r,children:r},r))]})}),e.jsx("div",{className:"filter-group",children:e.jsx("button",{className:`toggle-btn ${d?"active":""}`,onClick:()=>l(!d),children:"📊 Estadísticas"})})]}),e.jsx("div",{className:"products-grid",children:O.map(r=>e.jsxs("div",{className:"product-card",children:[e.jsx("div",{className:"product-icon",style:{color:r.color},children:r.icon}),e.jsxs("div",{className:"product-info",children:[e.jsx("h3",{children:r.displayName}),e.jsx("p",{className:"product-category",children:r.category}),e.jsx("p",{className:"product-description",children:r.description}),e.jsxs("div",{className:"product-stats",children:[e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-label",children:"Stock:"}),e.jsxs("span",{className:"stat-value",children:[r.currentStock||0," ",r.unit]})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-label",children:"Precio:"}),e.jsxs("span",{className:"stat-value",children:["$",new Intl.NumberFormat("es-CO").format(r.defaultPrice||0)]})]})]}),e.jsx("div",{className:`product-status ${r.isActive?"active":"inactive"}`,children:r.isActive?"✅ Activo":"❌ Inactivo"})]}),e.jsxs("div",{className:"product-actions",children:[e.jsx("button",{className:"btn-secondary",onClick:()=>x(r),children:"👁️ Ver"}),s&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-primary",onClick:()=>A(r),children:"✏️ Editar"}),e.jsx("button",{className:"btn-danger",onClick:()=>w(r.id),children:"🗑️ Eliminar"})]})]})]},r.id))}),O.length===0&&e.jsxs("div",{className:"empty-state",children:[e.jsx("div",{className:"empty-icon",children:"📦"}),e.jsx("h3",{children:"No hay productos"}),e.jsx("p",{children:j||a?"No se encontraron productos con los filtros aplicados.":"Aún no hay productos registrados."}),s&&!j&&!a&&e.jsx("button",{className:"btn-primary",onClick:h,children:"➕ Crear primer producto"})]}),e.jsx(z,{isOpen:b,onClose:()=>i(!1),product:S,mode:P,onSave:F,userRole:y?.role})]})};export{R as default};
